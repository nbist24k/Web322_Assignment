<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Edit Article</title>
    <%- include('partials/head') %>
  </head>
  <body class="d-flex-container">
    <%- include('partials/nav') %>

    <div class="container mt-5 content">
      <h2>Edit Article</h2>

      <% if (error) { %>
        <div class="alert alert-danger" role="alert">
          <%= error %>
        </div>
      <% } else if (article) { %>
        <form id="editForm" onsubmit="handleSubmit(event)">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input
              type="text"
              class="form-control"
              id="title"
              name="title"
              value="<%= article.title %>"
              required
            />
          </div>
          <div class="mb-3">
            <label for="content" class="form-label">Content</label>
            <textarea
              class="form-control"
              id="content"
              name="content"
              rows="5"
              required
            ><%= article.content %></textarea>
          </div>
          <div class="mb-3">
            <label for="categoryId" class="form-label">Category</label>
            <select
              class="form-control"
              id="categoryId"
              name="categoryId"
              required
            >
              <option value="">Select a category</option>
              <% categories.forEach(function(category) { %>
                <option value="<%= category.id %>" <%= article.categoryId === category.id ? 'selected' : '' %>>
                  <%= category.name %>
                </option>
              <% }); %>
            </select>
          </div>
          <div class="mb-3">
            <label for="featureImage" class="form-label">Feature Image URL</label>
            <input
              type="url"
              class="form-control"
              id="featureImage"
              name="featureImage"
              value="<%= article.featureImage %>"
            />
          </div>
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="published"
              name="published"
              <%= article.published ? 'checked' : '' %>
            />
            <label class="form-check-label" for="published">Published</label>
          </div>
          <div class="mb-3">
            <label for="source" class="form-label">Source URL</label>
            <input
              type="url"
              class="form-control"
              id="source"
              name="source"
              value="<%= article.source %>"
            />
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Update Article</button>
            <button type="button" class="btn btn-danger" onclick="handleDelete()">Delete Article</button>
          </div>
        </form>

        <script>
          async function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
              const response = await fetch(`/articles/<%= article.id %>`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  title: formData.get('title'),
                  content: formData.get('content'),
                  categoryId: formData.get('categoryId'),
                  published: formData.get('published') === 'on',
                  featureImage: formData.get('featureImage'),
                  source: formData.get('source')
                }),
              });

              if (!response.ok) {
                throw new Error('Failed to update article');
              }

              window.location.href = '/articles';
            } catch (error) {
              alert('Error updating article: ' + error.message);
            }
          }

          async function handleDelete() {
            if (!confirm('Are you sure you want to delete this article?')) {
              return;
            }

            try {
              const response = await fetch(`/articles/<%= article.id %>`, {
                method: 'DELETE',
              });

              if (!response.ok) {
                throw new Error('Failed to delete article');
              }

              window.location.href = '/articles';
            } catch (error) {
              alert('Error deleting article: ' + error.message);
            }
          }
        </script>
      <% } %>
    </div>

    <%- include('partials/footer') %>
  </body>
</html>